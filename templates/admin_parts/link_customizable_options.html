<section class="container mb-5 position-relative">
  <h4 class="color-AB131C fw-bold mb-4">ğŸ”— Ø±Ø¨Ø· Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ®ØµÙŠØµ Ù…Ø¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>

  <!-- Ù…ÙƒØ§Ù† Ø¸Ù‡ÙˆØ± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§Ø´ ÙƒÙ€ Toast -->
  <div id="flash-message" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¨Ø· -->
  <form id="customLinkForm" method="POST" class="border border-2 rounded-4 bg-light p-4 mb-3">
    <div class="row align-items-center">
      <div class="col-md-4 mb-3">
        <select id="customItemSelect" name="link_custom_item_id" required class="form-control rounded-3 border border-1">
          <option disabled selected value="">Ø§Ø®ØªØ± ØµÙ†Ù Ù„Ù„Ø±Ø¨Ø·</option>
          {% for item in items %}
            <option value="{{ item.id }}">{{ item.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8 mb-3" style="max-height: 200px; overflow-y: auto;">
        <div class="bg-white border border-1 rounded-3 p-3 shadow-sm">
          {% for option in options %}
            {% set matching_customizables = customizables | selectattr('id', 'equalto', option.customizable_ingredient_id) | list %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="customizable_option_ids" value="{{ option.id }}" id="opt{{ option.id }}">
              <label class="form-check-label" for="opt{{ option.id }}">
                {{ option.name }}
                {% if matching_customizables|length > 0 %}
                  ({{ matching_customizables[0].name }})
                {% else %}
                  (Ù…ÙƒÙˆÙ† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ)
                {% endif %}
              </label>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <button type="submit" name="action" value="link_custom" class="btn background-color-AB131C text-white fw-bold w-100 rounded-3">
      ğŸ”— Ø±Ø¨Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø§Ù„ØµÙ†Ù
    </button>
  </form>

  <!-- Ø¹Ø±Ø¶ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¹ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
  <div class="table-responsive shadow-sm rounded-4 overflow-hidden">
    <table class="table table-bordered text-center align-middle m-0">
      <thead class="background-color-AB131C text-white">
        <tr>
          <th>Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø·</th>
          <th>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·</th>
        </tr>
      </thead>
      <tbody>
        {% for link in item_custom_links %}
        <tr>
          <td>{{ link.item_name }}</td>
          <td>{{ link.option_name }}</td>
          <td>
            <form method="POST" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·ØŸ');" style="display:inline;">
              <input type="hidden" name="unlink_custom_item_id" value="{{ link.item_id }}">
              <input type="hidden" name="unlink_custom_option_id" value="{{ link.option_id }}">
              <button name="action" value="unlink_custom" class="btn no-hover btn-sm  px-3">Ø§Ù„ØºØ§Ø¡</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="3" class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- Ø³ÙƒØ±Ø¨Øª Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙ„Ø§Ø´ ÙƒÙ€ Toast + Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙ„Ø§Ø´ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      let flashContainer = document.getElementById('flash-message');
      {% for message in messages %}
        let toast = document.createElement('div');
        toast.className = 'toast align-items-center text-bg-success border-0 show mb-2 shadow rounded-3';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        flashContainer.appendChild(toast);
        setTimeout(() => { toast.classList.remove('show'); toast.remove(); }, 3000);
      {% endfor %}
    {% endif %}
  {% endwith %}

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù ÙˆØ®ÙŠØ§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  const form = document.getElementById("customLinkForm");
  const itemSelect = document.getElementById("customItemSelect");

  form.addEventListener("submit", function(e) {
    if (!itemSelect.value) {
      e.preventDefault();
      showFlash("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù Ù„Ù„Ø±Ø¨Ø·", "danger");
      return;
    }

    const checkboxes = form.querySelectorAll('input[name="customizable_option_ids"]:checked');
    if (checkboxes.length === 0) {
      e.preventDefault();
      showFlash("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "danger");
      return;
    }
  });

  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ³Øª
  function showFlash(message, type = "success") {
    const flashContainer = document.getElementById('flash-message');
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2 shadow rounded-3`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    flashContainer.appendChild(toast);
    setTimeout(() => {
      toast.classList.remove('show');
      toast.remove();
    }, 3000);
  }
});
</script>
