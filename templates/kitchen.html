<!-- templates/kitchen.html -->
{% extends 'navbar.html' %}
{% block body %}

<div class="container mt-5">
    <h2 class="mb-4">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©</h2>
    {% if orders %}
    <div id="orders_container">
    <!-- Ù‡Ù†Ø§ ÙŠÙ†Ø¶Ø§Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
    
       <div class="accordion" id="ordersAccordion">
  {% for order in orders %}
  <div class="accordion-item mb-3">
    <h2 class="accordion-header" id="heading{{ order.id }}">
      <button class="accordion-button collapsed color-AB131C-hover" type="button" data-bs-toggle="collapse"
        data-bs-target="#collapse{{ order.id }}" aria-expanded="false" aria-controls="collapse{{ order.id }}">
        ğŸ§¾ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… {{ order.id }} - : {{ order.name }} - {{ order.status | upper }} 
      </button> 
    </h2>
    <div id="collapse{{ order.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ order.id }}"
      data-bs-parent="#ordersAccordion">
      <div class="accordion-body">

        <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> {{ order.order_time }}</p>
        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ order.phone_number }}</p>

        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±:</strong> {{ order.items_count }}</p>

        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± -->
       <!-- Ø¯Ø§Ø®Ù„ Ø­Ù„Ù‚Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± order.order_items -->
<ul class="list-group mb-3">
  {% for item in order.order_items %}
  <li class="list-group-item d-flex justify-content-between align-items-start">
    <div>
      <div class="fw-bold">{{ item.name }}</div>
      Ø§Ù„ÙƒÙ…ÙŠØ©: {{ item.quantity }} <br />
      Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: {{ item.base_price }} JD <br />
      Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ: {{ item.extra_price }} JD <br />

      {% if item.fixed_ingredients %}
      <small><strong>Ù…ÙƒÙˆÙ†Ø§Øª Ø«Ø§Ø¨ØªØ©:</strong></small>
      <ul class="mb-1">
        {% for ingr in item.fixed_ingredients %}
        <li>{{ ingr }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if item.custom_options %}
      <small><strong>Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ØµØµØ©:</strong></small>
      <ul class="mb-1">
       {% for option in item.custom_options %}
          <li>{{ option.ingredient_name }}: {{ option.option_name }}</li>
        {% endfor %}

      </ul>
      {% endif %}

      {% if item.notes %}
      <small class="text-muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: {{ item.notes }}</small>
      {% endif %}
    </div>
    <span class="badge background-color-414141 rounded-pill">{{ item.item_total }} JD</span>
  </li>
  {% endfor %}
</ul>

<p class="fw-bold text-end">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: {{ order.total }} JD</p>

        {% if order.status != 'ready' %}
        <a href="{{ url_for('mark_ready', order_id=order.id) }}" class="btn background-color-AB131C text-white">ÙˆØ¶Ø¹ ÙƒÙ€ Ø¬Ø§Ù‡Ø²</a>
        {% else %}
        <span class="badge background-color-AB131C">âœ… Ø¬Ø§Ù‡Ø²</span>
        {% endif %}

      </div>
    </div>
  </div>
  {% endfor %}
</div>
        </div>
    {% else %}
        <div class="alert alert-info">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
    {% endif %}
</div>


<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const socket = io();
    let joined = false;

    // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    socket.on("connect", () => {
        if (!joined) {
            socket.emit("join", { user_id: "owner_room" });
            joined = true;
        }
    });

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
    socket.on("new_order", function(data) {
        const message = data.message;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† Ù‚Ø¨Ù„
        if (document.querySelector(`.alert-info[data-msg="${message}"]`)) {
            return; // ØªÙ… Ø¹Ø±Ø¶Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„
        }

        const notifDiv = document.createElement("div");
        notifDiv.className = "alert alert-info mt-3";
        notifDiv.setAttribute("data-msg", message);  // Ø­ØªÙ‰ Ù†Ù‚Ø¯Ø± Ù†ØªØ­Ù‚Ù‚ Ù„Ø§Ø­Ù‚Ù‹Ø§
        notifDiv.innerText = message;

        const container = document.getElementById("orders_container");
        container.prepend(notifDiv);
    });
</script>

{% endblock %}
